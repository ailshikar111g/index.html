<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAMADA TV</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.2/plyr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .live-player-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .live-player {
            width: 100%;
            height: auto;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .quality-selector {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 20px;
            display: none;
            white-space: nowrap;
            max-width: 90%;
            overflow-x: auto;
        }

        .quality-selector h3 {
            color: white;
            margin: 0 10px 0 0;
            font-size: 12px;
            display: inline-block;
            vertical-align: middle;
        }

        .quality-buttons-container {
            display: inline-block;
        }

        .quality-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 4px 10px;
            margin: 0 3px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: inline-block;
        }

        .quality-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .quality-btn.active {
            background: #2ecc71;
            box-shadow: 0 0 5px rgba(46, 204, 113, 0.7);
        }

        .player-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                        rgba(0,0,0,0.3) 0%, 
                        transparent 30%,
                        transparent 70%, 
                        rgba(0,0,0,0.3) 100%);
            pointer-events: none;
            z-index: 2;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="live-player-container">
        <div class="live-player">
            <video id="player" controls autoplay></video>
            <div class="quality-selector" id="qualitySelector">
                <h3>الجودة:</h3>
                <div class="quality-buttons-container" id="qualityButtons"></div>
            </div>
            <div class="player-overlay"></div>
        </div>
    </div>

    <script>
        const video = document.getElementById('player');
        const qualitySelector = document.getElementById('qualitySelector');
        const qualityButtons = document.getElementById('qualityButtons');
        let hls;
        let dashPlayer;
        let player = new Plyr('#player', {
            controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
            ratio: '16:9'
        });

        function createQualityButtons(levels) {
            qualitySelector.style.display = 'none';
            qualityButtons.innerHTML = '';

            if (levels.length <= 1) return;

            const autoBtn = document.createElement('button');
            autoBtn.className = 'quality-btn active';
            autoBtn.textContent = 'تلقائي';
            autoBtn.onclick = () => {
                if (hls) hls.currentLevel = -1;
                if (dashPlayer) dashPlayer.setAutoSwitchQualityFor('video', true);
                updateActiveButton(autoBtn);
            };
            qualityButtons.appendChild(autoBtn);

            levels.forEach((level, index) => {
                const btn = document.createElement('button');
                btn.className = 'quality-btn';
                let qualityText = level.height ? level.height + 'p' : 'Level ' + index;
                btn.textContent = qualityText;
                btn.onclick = () => {
                    if (hls) hls.currentLevel = index;
                    if (dashPlayer) {
                        dashPlayer.setAutoSwitchQualityFor('video', false);
                        dashPlayer.setQualityFor('video', index);
                    }
                    updateActiveButton(btn);
                };
                qualityButtons.appendChild(btn);
            });

            if (qualityButtons.children.length > 1) {
                qualitySelector.style.display = 'block';
            }
        }

        function updateActiveButton(activeBtn) {
            const buttons = document.querySelectorAll('.quality-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            activeBtn.classList.add('active');
        }

        window.addEventListener('load', function() {
            // تم تغيير الرابط إلى الرابط الجديد
            const streamUrl = 'http://ajyal.xyz:8080/live/24732701587944/25036225300990/275345.m3u8';

            if (streamUrl.endsWith('.m3u8')) {
                if (Hls.isSupported()) {
                    hls = new Hls({
                        // إعدادات إضافية لتحسين التوافق
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    hls.loadSource(streamUrl);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                        if (data.levels && data.levels.length > 1) {
                            createQualityButtons(data.levels);
                        }
                        video.play().catch(e => {
                            console.log('Auto-play prevented:', e);
                        });
                    });
                    
                    // معالجة الأخطاء
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS Error:', data);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.log('Network error, trying to recover');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.log('Media error, recovering');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    console.log('Fatal error, cannot recover');
                                    break;
                            }
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = streamUrl;
                    video.addEventListener('loadedmetadata', function() {
                        video.play().catch(e => {
                            console.log('Auto-play prevented:', e);
                        });
                    });
                }
            } else if (streamUrl.endsWith('.mpd')) {
                dashPlayer = dashjs.MediaPlayer().create();
                dashPlayer.initialize(video, streamUrl, true);
                dashPlayer.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, function() {
                    const bitrates = dashPlayer.getBitrateInfoListFor('video');
                    if (bitrates && bitrates.length > 1) {
                        createQualityButtons(bitrates.map((b, i) => ({ height: b.height || 0, index: i })));
                    }
                });
            }
        });
    </script>
</body>
</html>